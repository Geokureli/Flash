/*
  JavaScript Flod 1.0
  2012/02/08
  Christian Corti
  Neoart Costa Rica

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
  IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

  This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License.
  To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/ or send a letter to
  Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
*/
(function(){function j(f){return Object.create(null,{index:{value:f,writable:!0},next:{value:null,writable:!0},channel:{value:null,writable:!0},sample:{value:null,writable:!0},enabled:{value:0,writable:!0},period:{value:0,writable:!0},effect:{value:0,writable:!0},param:{value:0,writable:!0},volume1:{value:0,writable:!0},volume2:{value:0,writable:!0},handler:{value:0,writable:!0},portaDir:{value:0,writable:!0},portaPeriod:{value:0,writable:!0},portaSpeed:{value:0,writable:!0},vibratoPos:{value:0,writable:!0},
vibratoSpeed:{value:0,writable:!0},wavePos:{value:0,writable:!0},initialize:{value:function(){this.sample=this.channel=null;this.wavePos=this.vibratoSpeed=this.vibratoPos=this.portaSpeed=this.portaPeriod=this.portaDir=this.handler=this.volume2=this.volume1=this.param=this.effect=this.period=this.enabled=0}}})}function l(){var f=AmigaSample();Object.defineProperties(f,{finetune:{value:0,writable:!0},restart:{value:0,writable:!0},waveLen:{value:0,writable:!0},waves:{value:null,writable:!0},volumes:{value:null,
writable:!0}});return Object.seal(f)}var m=[0,3,7,12,15,12,7,3,0,3,7,12,15,12,7,3,0,4,7,12,16,12,7,4,0,4,7,12,16,12,7,4,0,3,8,12,15,12,8,3,0,3,8,12,15,12,8,3,0,4,8,12,16,12,8,4,0,4,8,12,16,12,8,4,0,5,8,12,17,12,8,5,0,5,8,12,17,12,8,5,0,5,9,12,17,12,9,5,0,5,9,12,17,12,9,5,12,0,7,0,3,0,7,0,12,0,7,0,3,0,7,0,12,0,7,0,4,0,7,0,12,0,7,0,4,0,7,0,0,3,7,3,7,12,7,12,15,12,7,12,7,3,7,3,0,4,7,4,7,12,7,12,16,12,7,12,7,4,7,4,31,27,24,19,15,12,7,3,0,3,7,12,15,19,24,27,31,28,24,19,16,12,7,4,0,4,7,12,16,19,24,28,0,
12,0,12,0,12,0,12,0,12,0,12,0,12,0,12,0,12,24,12,0,12,24,12,0,12,24,12,0,12,24,12,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4],k=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,0],n=[0,24,49,74,97,120,141,161,180,197,212,224,235,244,250,253,255,253,250,244,235,224,212,197,180,161,141,120,97,74,49,24];window.neoart.HMPlayer=function(f){f=AmigaPlayer(f);Object.defineProperties(f,{id:{value:"HMPlayer"},
track:{value:null,writable:!0},patterns:{value:[],writable:!0},samples:{value:[],writable:!0},length:{value:0,writable:!0},restart:{value:0,writable:!0},voices:{value:[],writable:!0},trackPos:{value:0,writable:!0},patternPos:{value:0,writable:!0},jumpFlag:{value:0,writable:!0},initialize:{value:function(){var a=this.voices[0];this.reset();this.speed=6;this.jumpFlag=this.patternPos=this.trackPos=0;for(this.mixer.samplesTick=884;a;)a.initialize(),a.channel=this.mixer.channels[a.index],a.sample=this.samples[0],
a=a.next}},loader:{value:function(a){var i=0,e=0,g,d,c=0,b,f=0,h;if(!(2150>a.length)&&(a.position=1080,g=a.readString(4),"FEST"==g)){a.position=950;this.length=a.readUbyte();for(this.restart=a.readUbyte();128>e;++e)this.track[e]=a.readUbyte();a.position=0;this.title=a.readString(20);for(e=this.version=1;32>e;++e){this.samples[e]=null;g=a.readString(4);if("Mupp"==g){h=a.readUbyte();for(d=0;128>d;++d)this.track[d]&&this.track[d]>=h&&this.track[d]--;b=l();b.name=g;b.length=b.repeat=32;b.restart=a.readUbyte();
b.waveLen=a.readUbyte();a.position+=17;b.finetune=a.readByte();b.volume=a.readUbyte();g=a.position+4;h=1084+(h<<10);a.position=h;b.pointer=this.mixer.memory.length;b.waves=new Uint16Array(64);b.volumes=new Uint8Array(64);this.mixer.store(a,896);for(d=0;64>d;++d)b.waves[d]=a.readUbyte()<<5;for(d=0;64>d;++d)b.volumes[d]=a.readUbyte()&127;a.position=h;a.writeInt(1718382436);a.position=g;c+=896}else{g=g.substr(0,2);"El"==g?a.position+=18:(a.position-=4,g=a.readString(22));h=a.readUshort();if(!h){a.position+=
6;continue}b=l();b.name=g;b.pointer=f;b.length=h<<1;b.finetune=a.readByte();b.volume=a.readUbyte();b.loop=a.readUshort()<<1;b.repeat=a.readUshort()<<1;f+=b.length}this.samples[e]=b}for(e=0;128>e;++e)h=this.track[e]<<8,this.track[e]=h,h>i&&(i=h);a.position=1084;i+=256;this.patterns.length=i;for(e=0;e<i;++e){for(h=a.readUint();1718382436==h;)a.position+=1020,h=a.readUint();d=AmigaRow();d.note=h>>16&4095;d.sample=h>>24&240|h>>12&15;d.effect=h>>8&15;d.param=h&255;this.patterns[e]=d}this.mixer.store(a,
f);for(e=1;32>e;++e)if(b=this.samples[e],!(null==b||"Mupp"==b.name)){b.pointer+=c;b.loop?(b.loopPtr=b.pointer+b.loop,b.length=b.loop+b.repeat):(b.loopPtr=this.mixer.memory.length,b.repeat=2);f=b.pointer+4;for(d=b.pointer;d<f;++d)this.mixer.memory[d]=0}b=l();b.pointer=b.loopPtr=this.mixer.memory.length;b.length=b.repeat=2;this.samples[0]=b}}},process:{value:function(){var a,f,e,g,d,c=this.voices[0];if(this.tick)for(;c;)this.effects(c),this.handler(c),g=c.sample,c.channel.pointer=g.loopPtr,c.channel.length=
g.repeat,c=c.next;else for(f=this.track[this.trackPos]+this.patternPos;c;){a=c.channel;c.enabled=0;e=this.patterns[f+c.index];c.effect=e.effect;c.param=e.param;e.sample?(g=c.sample=this.samples[e.sample],c.volume2=g.volume,"Mupp"==g.name?(g.loopPtr=g.pointer+g.waves[0],c.handler=1,c.volume1=g.volumes[0]):(c.handler=0,c.volume1=64)):g=c.sample;e.note&&(3==c.effect||5==c.effect?e.note<c.period?(c.portaDir=1,c.portaPeriod=e.note):e.note>c.period?(c.portaDir=0,c.portaPeriod=e.note):c.portaPeriod=0:(c.period=
e.note,c.vibratoPos=0,c.wavePos=0,c.enabled=1,a.enabled=0,d=c.period*g.finetune>>8,a.period=c.period+d,c.handler?(a.pointer=g.loopPtr,a.length=g.repeat):(a.pointer=g.pointer,a.length=g.length)));switch(c.effect){case 11:this.trackPos=c.param-1;this.jumpFlag=1;break;case 12:c.volume2=c.param;64<c.volume2&&(c.volume2=64);break;case 13:this.jumpFlag=1;break;case 14:this.mixer.filter.active=c.param^1;break;case 15:d=c.param,1>d?d=1:31<d&&(d=31),this.speed=d,this.tick=0}e.note||this.effects(c);this.handler(c);
c.enabled&&(a.enabled=1);a.pointer=g.loopPtr;a.length=g.repeat;c=c.next}if(++this.tick==this.speed&&(this.tick=0,this.patternPos+=4,256==this.patternPos||this.jumpFlag))this.patternPos=this.jumpFlag=0,this.trackPos=++this.trackPos&127,this.trackPos==this.length&&(this.trackPos=this.restart,this.mixer.complete=1)}},effects:{value:function(a){var f=a.channel,e,g,d=a.period&4095,c,b;if(a.effect||a.param)switch(a.effect){case 0:b=this.tick%3;if(!b)break;b=1==b?a.param>>4:a.param&15;g=37-b;for(e=0;e<g;++e)if(d>=
k[e]){d=k[e+b];break}break;case 1:a.period-=a.param;113>a.period&&(a.period=113);d=a.period;break;case 2:a.period+=a.param;856<a.period&&(a.period=856);d=a.period;break;case 3:case 5:5==a.effect?c=1:a.param&&(a.portaSpeed=a.param,a.param=0);a.portaPeriod&&(a.portaDir?(a.period-=a.portaSpeed,a.period<a.portaPeriod&&(a.period=a.portaPeriod,a.portaPeriod=0)):(a.period+=a.portaSpeed,a.period>a.portaPeriod&&(a.period=a.portaPeriod,a.portaPeriod=0)));d=a.period;break;case 4:case 6:6==a.effect?c=1:a.param&&
(a.vibratoSpeed=a.param);b=n[a.vibratoPos>>2&31];b=(a.vibratoSpeed&15)*b>>7;d=127<a.vibratoPos?d-b:d+b;b=a.vibratoSpeed>>2&60;a.vibratoPos=a.vibratoPos+b&255;break;case 7:b=m[(a.vibratoPos&15)+((a.param&15)<<4)];a.vibratoPos++;for(e=0;37>e&&!(d>=k[e]);++e);b+=e;35<b&&(b-=12);d=k[b];break;case 10:c=1}f.period=d+(d*a.sample.finetune>>8);c&&(b=a.param>>4,a.volume2=b?a.volume2+b:a.volume2-(a.param&15),64<a.volume2?a.volume2=64:0>a.volume2&&(a.volume2=0))}},handler:{value:function(a){var f;a.handler&&
(f=a.sample,f.loopPtr=f.pointer+f.waves[a.wavePos],a.volume1=f.volumes[a.wavePos],++a.wavePos>f.waveLen&&(a.wavePos=f.restart));a.channel.volume=a.volume1*a.volume2>>6}}});f.voices[0]=j(0);f.voices[0].next=f.voices[1]=j(1);f.voices[1].next=f.voices[2]=j(2);f.voices[2].next=f.voices[3]=j(3);f.track=new Uint16Array(128);return Object.seal(f)}})();