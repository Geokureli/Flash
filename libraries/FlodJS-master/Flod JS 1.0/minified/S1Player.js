/*
  JavaScript Flod 1.0
  2012/02/08
  Christian Corti
  Neoart Costa Rica

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
  IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

  This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License.
  To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/ or send a letter to
  Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
*/
(function(){function l(g){return Object.create(null,{index:{value:g,writable:!0},next:{value:null,writable:!0},channel:{value:null,writable:!0},step:{value:0,writable:!0},row:{value:0,writable:!0},sample:{value:0,writable:!0},samplePtr:{value:0,writable:!0},sampleLen:{value:0,writable:!0},note:{value:0,writable:!0},noteTimer:{value:0,writable:!0},period:{value:0,writable:!0},volume:{value:0,writable:!0},bendTo:{value:0,writable:!0},bendSpeed:{value:0,writable:!0},arpeggioCtr:{value:0,writable:!0},
envelopeCtr:{value:0,writable:!0},pitchCtr:{value:0,writable:!0},pitchFallCtr:{value:0,writable:!0},sustainCtr:{value:0,writable:!0},phaseTimer:{value:0,writable:!0},phaseSpeed:{value:0,writable:!0},wavePos:{value:0,writable:!0},waveList:{value:0,writable:!0},waveTimer:{value:0,writable:!0},waitCtr:{value:0,writable:!0},initialize:{value:function(){this.sample=this.row=this.step=0;this.samplePtr=-1;this.noteTimer=this.note=this.sampleLen=0;this.period=39321;this.waitCtr=this.waveTimer=this.waveList=
this.wavePos=this.phaseSpeed=this.phaseTimer=this.sustainCtr=this.pitchFallCtr=this.pitchCtr=this.envelopeCtr=this.arpeggioCtr=this.bendSpeed=this.bendTo=this.volume=0}}})}function n(){var g=AmigaSample();Object.defineProperties(g,{waveform:{value:0,writable:!0},arpeggio:{value:null,writable:!0},attackSpeed:{value:0,writable:!0},attackMax:{value:0,writable:!0},decaySpeed:{value:0,writable:!0},decayMin:{value:0,writable:!0},sustain:{value:0,writable:!0},releaseSpeed:{value:0,writable:!0},releaseMin:{value:0,
writable:!0},phaseShift:{value:0,writable:!0},phaseSpeed:{value:0,writable:!0},finetune:{value:0,writable:!0},pitchFall:{value:0,writable:!0}});g.arpeggio=new Uint8Array(16);return Object.seal(g)}var p=[1166,408,908],o=[0,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,452,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,
160,151,143,135,127,0,0,0,0,0,0,0,4028,3806,3584,3394,3204,3013,2855,2696,2538,2395,2268,2141,2014,1903,1792,1697,1602,1507,1428,1348,1269,1198,1134,1071,1007,952,896,849,801,754,714,674,635,599,567,536,504,476,448,425,401,377,357,337,310,300,284,268,252,238,224,213,201,189,179,169,159,150,142,134,0,0,0,0,0,0,0,3993,3773,3552,3364,3175,2987,2830,2672,2515,2374,2248,2122,1997,1887,1776,1682,1588,1494,1415,1336,1258,1187,1124,1061,999,944,888,841,794,747,708,668,629,594,562,531,500,472,444,421,397,
374,354,334,315,297,281,266,250,236,222,211,199,187,177,167,158,149,141,133,0,0,0,0,0,0,0,3957,3739,3521,3334,3147,2960,2804,2648,2493,2353,2228,2103,1979,1870,1761,1667,1574,1480,1402,1324,1247,1177,1114,1052,990,935,881,834,787,740,701,662,624,589,557,526,495,468,441,417,394,370,351,331,312,295,279,263,248,234,221,209,197,185,176,166,156,148,140,132,0,0,0,0,0,0,0,3921,3705,3489,3304,3119,2933,2779,2625,2470,2331,2208,2084,1961,1853,1745,1652,1560,1467,1390,1313,1235,1166,1104,1042,981,927,873,826,
780,734,695,657,618,583,552,521,491,464,437,413,390,367,348,329,309,292,276,261,246,232,219,207,195,184,174,165,155,146,138,131,0,0,0,0,0,0,0,3886,3671,3457,3274,3090,2907,2754,2601,2448,2310,2188,2065,1943,1836,1729,1637,1545,1454,1377,1301,1224,1155,1094,1033,972,918,865,819,773,727,689,651,612,578,547,517,486,459,433,410,387,364,345,326,306,289,274,259,243,230,217,205,194,182,173,163,153,145,137,130,0,0,0,0,0,0,0,3851,3638,3426,3244,3062,2880,2729,2577,2426,2289,2168,2047,1926,1819,1713,1622,1531,
1440,1365,1289,1213,1145,1084,1024,963,910,857,811,766,720,683,645,607,573,542,512,482,455,429,406,383,360,342,323,304,287,271,256,241,228,215,203,192,180,171,162,152,144,136,128,6848,6464,6096,5760,5424,5120,4832,4560,4304,4064,3840,3616,3424,3232,3048,2880,2712,2560,2416,2280,2152,2032,1920,1808,1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,904,856,808,762,720,678,640,604,570,538,508,480,452,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127];window.neoart.S1Player=
function(g){g=AmigaPlayer(g);Object.defineProperties(g,{id:{value:"S1Player"},tracksPtr:{value:null,writable:!0},tracks:{value:[],writable:!0},patternsPtr:{value:null,writable:!0},patterns:{value:[],writable:!0},samples:{value:[],writable:!0},waveLists:{value:null,writable:!0},speedDef:{value:0,writable:!0},patternDef:{value:0,writable:!0},mix1Speed:{value:0,writable:!0},mix2Speed:{value:0,writable:!0},mix1Dest:{value:0,writable:!0},mix2Dest:{value:0,writable:!0},mix1Source1:{value:0,writable:!0},
mix1Source2:{value:0,writable:!0},mix2Source1:{value:0,writable:!0},mix2Source2:{value:0,writable:!0},doFilter:{value:0,writable:!0},doReset:{value:0,writable:!0},voices:{value:[],writable:!0},trackPos:{value:0,writable:!0},trackEnd:{value:0,writable:!0},trackLen:{value:0,writable:!0},patternPos:{value:0,writable:!0},patternEnd:{value:0,writable:!0},patternLen:{value:0,writable:!0},mix1Ctr:{value:0,writable:!0},mix2Ctr:{value:0,writable:!0},mix1Pos:{value:0,writable:!0},mix2Pos:{value:0,writable:!0},
audPtr:{value:0,writable:!0},audLen:{value:0,writable:!0},audPer:{value:0,writable:!0},audVol:{value:0,writable:!0},initialize:{value:function(){var b,e,c=this.voices[0];this.reset();this.tick=this.speed=this.speedDef;this.trackPos=1;this.trackEnd=0;this.patternPos=-1;this.patternEnd=0;this.patternLen=this.patternDef;for(this.mix2Ctr=this.mix2Pos=this.mix1Ctr=this.mix1Pos=0;c;)c.initialize(),b=this.mixer.channels[c.index],c.channel=b,c.step=this.tracksPtr[c.index],e=this.tracks[c.step],c.row=this.patternsPtr[e.pattern],
c.sample=this.patterns[c.row].sample,b.length=32,b.period=c.period,b.enabled=1,c=c.next}},loader:{value:function(b){for(var e,c,j,h,a,i,d,f,g,l,k,m;8<b.bytesAvailable;)if(f=b.readUshort(),16890==f&&(j=b.readUshort(),f=b.readUshort(),53736==f&&(f=b.readUshort(),65492==f))){m=4076==j?4090:5222==j?5188:j;i=j+b.position-6;break}if(i&&(b.position=i," SID-MON BY R.v.VLIET  (c) 1988 "==b.readString(32))){b.position=i-44;f=b.readUint();for(c=1;4>c;++c)this.tracksPtr[c]=(b.readUint()-f)/6>>0;b.position=i-
8;f=b.readUint();a=b.readUint();a<f&&(a=b.length-i);g=a-f>>2;this.patternsPtr=new Uint32Array(g);b.position=i+f+4;for(c=1;c<g;++c){f=b.readUint()/5>>0;if(0==f){g=c;break}this.patternsPtr[c]=f}this.patternsPtr.length=g;b.position=i-44;f=b.readUint();b.position=i-28;a=(b.readUint()-f)/6>>0;this.tracks.length=a;b.position=i+f;for(c=0;c<a;++c){f=AmigaStep();f.pattern=b.readUint();f.pattern>=g&&(f.pattern=0);b.readByte();f.transpose=b.readByte();if(-99>f.transpose||99<f.transpose)f.transpose=0;this.tracks[c]=
f}b.position=i-24;f=b.readUint();k=b.readUint()-f;for(c=0;32>c;++c)this.mixer.memory[c]=0;this.mixer.store(b,k,i+f);k>>=5;b.position=i-16;f=b.readUint();a=b.readUint()-f+16;j=k+2<<4;this.waveLists=new Uint8Array(a<j?j:a);b.position=i+f;for(c=0;c<j;)this.waveLists[c++]=c>>4,this.waveLists[c++]=255,this.waveLists[c++]=255,this.waveLists[c++]=16,c+=12;for(c=16;c<a;++c)this.waveLists[c]=b.readUbyte();b.position=i-20;b.position=i+b.readUint();this.mix1Source1=b.readUint();this.mix2Source1=b.readUint();
this.mix1Source2=b.readUint();this.mix2Source2=b.readUint();this.mix1Dest=b.readUint();this.mix2Dest=b.readUint();this.patternDef=b.readUint();this.trackLen=b.readUint();this.speedDef=b.readUint();this.mix1Speed=b.readUint();this.mix2Speed=b.readUint();this.mix1Source1>k&&(this.mix1Source1=0);this.mix2Source1>k&&(this.mix2Source1=0);this.mix1Source2>k&&(this.mix1Source2=0);this.mix2Source2>k&&(this.mix2Source2=0);this.mix1Dest>k&&(this.mix1Speed=0);this.mix2Dest>k&&(this.mix2Speed=0);0==this.speedDef&&
(this.speedDef=4);b.position=i-28;j=b.readUint();g=b.readUint()-j>>5;63<g&&(g=63);a=g+1;b.position=i-4;f=b.readUint();if(1==f){b.position=1820;f=b.readUshort();if(19962!=f&&(b.position=1788,f=b.readUshort(),19962!=f)){this.version=0;return}b.position+=b.readUshort();this.samples.length=a+3;for(c=0;3>c;++c)d=n(),d.waveform=16+c,d.length=p[c],d.pointer=this.mixer.store(b,d.length),d.loop=d.loopPtr=0,d.repeat=4,d.volume=64,this.samples[a+c]=d,b.position+=d.length}else this.samples.length=a,b.position=
i+f,e=b.readUint(),l=(e>>5)+15,h=b.position,e+=h;d=n();this.samples[0]=d;b.position=i+j;for(c=1;c<a;++c){d=n();d.waveform=b.readUint();for(j=0;16>j;++j)d.arpeggio[j]=b.readUbyte();d.attackSpeed=b.readUbyte();d.attackMax=b.readUbyte();d.decaySpeed=b.readUbyte();d.decayMin=b.readUbyte();d.sustain=b.readUbyte();b.readByte();d.releaseSpeed=b.readUbyte();d.releaseMin=b.readUbyte();d.phaseShift=b.readUbyte();d.phaseSpeed=b.readUbyte();d.finetune=b.readUbyte();d.pitchFall=b.readByte();5188==m?(d.pitchFall=
d.finetune,d.finetune=0):(15<d.finetune&&(d.finetune=0),d.finetune*=67);d.phaseShift>k&&(d.phaseShift=0,d.phaseSpeed=0);if(15<d.waveform)if(15<l&&d.waveform>l)d.waveform=0;else{f=h+(d.waveform-16<<5);if(f>=b.length)continue;j=b.position;b.position=f;d.pointer=b.readUint();d.loop=b.readUint();d.length=b.readUint();d.name=b.readString(20);0==d.loop||99999==d.loop||199999==d.loop||d.loop>=d.length?(d.loop=0,d.repeat=4090==m?2:4):(d.repeat=d.length-d.loop,d.loop-=d.pointer);d.length-=d.pointer;d.length<
d.loop+d.repeat&&(d.length=d.loop+d.repeat);d.pointer=this.mixer.store(b,d.length,e+d.pointer);d.loopPtr=6>d.repeat||0==d.loop?0:d.pointer+d.loop;b.position=j}else d.waveform>k&&(d.waveform=0);this.samples[c]=d}b.position=i-12;f=b.readUint();a=(b.readUint()-f)/5>>0;this.patterns.length=a;b.position=i+f;for(c=0;c<a;++c)e=AmigaRow(),Object.defineProperties(e,{speed:{value:0,writable:!0}}),e=Object.seal(e),e.note=b.readUbyte(),e.sample=b.readUbyte(),e.effect=b.readUbyte(),e.param=b.readUbyte(),e.speed=
b.readUbyte(),5188==m?(0<e.note&&255>e.note&&(e.note+=469),0<e.effect&&255>e.effect&&(e.effect+=469),59<e.sample&&(e.sample=g+(e.sample-60))):e.sample>g&&(e.sample=0),this.patterns[c]=e;4464==m||4550==m||5188==m?(4464==m&&(this.mix1Speed=this.mix2Speed=0),this.doReset=this.doFilter=0):this.doReset=this.doFilter=1;this.version=1}}},process:{value:function(){var b,e,c,g=this.mixer.memory,h,a;for(a=this.voices[0];a;){b=a.channel;this.audPtr=-1;this.audLen=this.audPer=this.audVol=0;if(0==this.tick)if(this.patternEnd&&
(this.trackEnd?a.step=this.tracksPtr[a.index]:a.step++,c=this.tracks[a.step],a.row=this.patternsPtr[c.pattern],this.doReset&&(a.noteTimer=0)),0==a.noteTimer){h=this.patterns[a.row];0==h.sample?h.note&&(a.noteTimer=h.speed,a.waitCtr&&(e=this.samples[a.sample],this.audPtr=e.pointer,this.audLen=e.length,a.samplePtr=e.loopPtr,a.sampleLen=e.repeat,a.waitCtr=1,b.enabled=0)):(e=this.samples[h.sample],a.waitCtr&&(b.enabled=a.waitCtr=0),15<e.waveform?(this.audPtr=e.pointer,this.audLen=e.length,a.samplePtr=
e.loopPtr,a.sampleLen=e.repeat,a.waitCtr=1):(a.wavePos=0,a.waveList=e.waveform,c=a.waveList<<4,this.audPtr=this.waveLists[c]<<5,this.audLen=32,a.waveTimer=this.waveLists[++c]),a.noteTimer=h.speed,a.sample=h.sample,a.envelopeCtr=a.pitchCtr=a.pitchFallCtr=0);if(h.note&&(a.noteTimer=h.speed,255!=h.note))switch(e=this.samples[a.sample],c=this.tracks[a.step],a.note=h.note+c.transpose,a.period=this.audPer=o[1+e.finetune+a.note],a.phaseSpeed=e.phaseSpeed,a.bendSpeed=a.volume=0,a.envelopeCtr=a.pitchCtr=a.pitchFallCtr=
0,h.effect){case 0:if(0==h.param)break;e.attackSpeed=h.param;e.attackMax=h.param;a.waveTimer=0;break;case 2:this.speed=h.param;a.waveTimer=0;break;case 3:this.patternLen=h.param;a.waveTimer=0;break;default:a.bendTo=h.effect+c.transpose,a.bendSpeed=h.param}a.row++}else a.noteTimer--;e=this.samples[a.sample];this.audVol=a.volume;switch(a.envelopeCtr){case 0:this.audVol+=e.attackSpeed;this.audVol>e.attackMax&&(this.audVol=e.attackMax,a.envelopeCtr+=2);break;case 2:this.audVol-=e.decaySpeed;if(this.audVol<=
e.decayMin||-256>this.audVol)this.audVol=e.decayMin,a.envelopeCtr+=2,a.sustainCtr=e.sustain;break;case 4:a.sustainCtr--;if(0==a.sustainCtr||-256==a.sustainCtr)a.envelopeCtr+=2;break;case 6:if(this.audVol-=e.releaseSpeed,this.audVol<=e.releaseMin||-256>this.audVol)this.audVol=e.releaseMin,a.envelopeCtr=8}a.volume=this.audVol;a.arpeggioCtr=++a.arpeggioCtr&15;c=e.finetune+e.arpeggio[a.arpeggioCtr]+a.note;a.period=this.audPer=o[c];if(a.bendSpeed&&(h=o[e.finetune+a.bendTo],c=~a.bendSpeed+1,-128>c&&(c&=
255),a.pitchCtr+=c,a.period+=a.pitchCtr,0>c&&a.period<=h||0<c&&a.period>=h))a.note=a.bendTo,a.period=h,a.bendSpeed=0,a.pitchCtr=0;e.phaseShift&&(a.phaseSpeed?a.phaseSpeed--:(a.phaseTimer=++a.phaseTimer&31,c=(e.phaseShift<<5)+a.phaseTimer,a.period+=g[c]>>2));a.pitchFallCtr-=e.pitchFall;-256>a.pitchFallCtr&&(a.pitchFallCtr+=256);a.period+=a.pitchFallCtr;0==a.waitCtr&&(a.waveTimer?a.waveTimer--:16>a.wavePos&&(c=(a.waveList<<4)+a.wavePos,h=this.waveLists[c++],255==h?a.wavePos=this.waveLists[c]&254:(this.audPtr=
h<<5,a.waveTimer=this.waveLists[c],a.wavePos+=2)));-1<this.audPtr&&(b.pointer=this.audPtr);0!=this.audPer&&(b.period=a.period);0!=this.audLen&&(b.length=this.audLen);b.volume=e.volume?e.volume:this.audVol>>2;b.enabled=1;a=a.next}this.trackEnd=this.patternEnd=0;++this.tick>this.speed&&(this.tick=0,++this.patternPos==this.patternLen&&(this.patternPos=0,this.patternEnd=1,++this.trackPos==this.trackLen&&(this.trackPos=this.trackEnd=this.mixer.complete=1)));if(this.mix1Speed){if(0==this.mix1Ctr){this.mix1Ctr=
this.mix1Speed;c=this.mix1Pos=++this.mix1Pos&31;b=(this.mix1Dest<<5)+31;a=(this.mix1Source1<<5)+31;h=this.mix1Source2<<5;for(e=31;-1<e;--e)g[b--]=g[a--]+g[h+c]>>1,c=--c&31}this.mix1Ctr--}if(this.mix2Speed){if(0==this.mix2Ctr){this.mix2Ctr=this.mix2Speed;c=this.mix2Pos=++this.mix2Pos&31;b=(this.mix2Dest<<5)+31;a=(this.mix2Source1<<5)+31;h=this.mix2Source2<<5;for(e=31;-1<e;--e)g[b--]=g[a--]+g[h+c]>>1,c=--c&31}this.mix2Ctr--}this.doFilter&&(c=this.mix1Pos+32,g[c]=~g[c]+1);for(a=this.voices[0];a;)b=a.channel,
1==a.waitCtr?a.waitCtr++:2==a.waitCtr&&(a.waitCtr++,b.pointer=a.samplePtr,b.length=a.sampleLen),a=a.next}}});g.voices[0]=l(0);g.voices[0].next=g.voices[1]=l(1);g.voices[1].next=g.voices[2]=l(2);g.voices[2].next=g.voices[3]=l(3);g.tracksPtr=new Uint32Array(4);return Object.seal(g)}})();